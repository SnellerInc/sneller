SELECT grp0, grp1, COUNT(*) AS x,
	   ROW_NUMBER() OVER (PARTITION BY grp0 ORDER BY COUNT(*)) AS rn
FROM input
GROUP BY grp0, grp1
# same as rownumber4.test but inlined:
HAVING ROW_NUMBER() OVER (PARTITION BY grp0 ORDER BY COUNT(*)) <= 2
ORDER BY grp0, grp1
---
ITERATE input FIELDS [grp0, grp1]
AGGREGATE ROW_NUMBER() OVER (PARTITION BY grp0 ORDER BY COUNT(*) ASC NULLS FIRST) AS $_0_0, COUNT(*) AS $_0_3 BY grp0 AS $_0_1, grp1 AS $_0_2
ORDER BY $_0_1 ASC NULLS FIRST, $_0_2 ASC NULLS FIRST
FILTER $_0_0 <= 2
PROJECT $_0_1 AS grp0, $_0_2 AS grp1, $_0_3 AS x, $_0_0 AS rn
---
UNION MAP input (
	ITERATE PART input FIELDS [grp0, grp1]
	AGGREGATE COUNT(*) AS $_2_1 BY grp0 AS $_0_1, grp1 AS $_0_2)
AGGREGATE ROW_NUMBER() OVER (PARTITION BY $_0_1 ORDER BY $_0_3 ASC NULLS FIRST) AS $_0_0, SUM_COUNT($_2_1) AS $_0_3 BY $_0_1 AS $_0_1, $_0_2 AS $_0_2
ORDER BY $_0_1 ASC NULLS FIRST, $_0_2 ASC NULLS FIRST
FILTER $_0_0 <= 2
PROJECT $_0_1 AS grp0, $_0_2 AS grp1, $_0_3 AS x, $_0_0 AS rn
